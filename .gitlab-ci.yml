stages:
  - build
  - test
  - docker

build-job:       # Construction de l'image
  image: gradle:jdk11
  stage: build
  before_script:
    - echo "Version de java"
    - which java
    - apt-get -qq update && apt-get install -qqy --no-install-recommends openconnect wget
    - openconnect nomade.etu.univ-nantes.fr --juniper --user=E21A432S -b < mdp.txt
  script:
    - echo "Compilation du code et creation d'un jar"
    - ./gradlew build -x test
    - ./gradlew jar
    - echo "Fin du build"


unit-test-job:   # Exécution des tests
  image: gradle:jdk11
  stage: test
  before_script:
    - export GRADLE_USER_HOME=`pwd`/.gradle
  script:
    - echo "Exécution des tests"
    - ./gradlew build
    - ./gradlew test
    - echo "Fin des tests"


deploy-job: # Test build docker
  stage: docker
  services:
    - docker:dind
  script:
    - echo "Build docker"
    - ./gradlew build
    - ./gradlew jar
    - docker build -t api-music.
    - docker run --name container-music-api -d -p 9090:80 api-music
    - echo "Liste docker et container"
    - docker ps && docker image ls
    - echo "Docker déployé avec succes."
