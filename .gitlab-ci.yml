stages:
  - build
  - test
  - docker

build-job:       # Construction de l'image
  image: gradle:jdk11
  variables:
    GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  stage: build
  timeout: 60 minutes
  before_script:
    - echo "Version de java"
    - which java
    - export GRADLE_USER_HOME=`pwd`/.gradle
  script:
    - echo "Compilation du code et creation d'un jar"
    - ./gradlew build -x test
    - ./gradlew jar
    - echo "Fin du build"


unit-test-job:   # Exécution des tests
  image: gradle:jdk11
  stage: test
  before_script:
    - export GRADLE_USER_HOME=`pwd`/.gradle
  script:
    - echo "Exécution des tests"
    - ./gradlew build
    - ./gradlew test
    - echo "Fin des tests"


deploy-job: # Test build docker
  stage: docker
  services:
    - docker:dind
  script:
    - echo "Build docker"
    - ./gradlew build
    - ./gradlew jar
    - docker build -t api-music.
    - docker run --name container-music-api -d -p 9090:80 api-music
    - echo "Liste docker et container"
    - docker ps && docker image ls
    - echo "Docker déployé avec succes."
